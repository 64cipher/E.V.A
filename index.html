<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolved Virtual Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&libraries=places&solution_channel=GMP_QB_baseURL_v4_A"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html, body {
            height: 100%;
            overflow: hidden; /* Emp√™che le d√©filement au niveau du body */
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }

        #mainAppContainer {
            display: flex;
            width: 100%;
            flex-grow: 1;
            padding: 1rem;
            gap: 1rem;
            justify-content: center;
            align-items: stretch; /* Fait en sorte que les enfants s'√©tirent */
            height: calc(100% - 120px); /* Ajuster la hauteur en fonction du titre */
            min-height: 0;
        }

        #infoPanelColumn {
            flex-basis: 45%;
            min-width: 0; 
            max-width: 45%;
            display: flex;
            flex-direction: column;
            transition: flex-basis 0.3s ease-in-out, min-width 0.3s ease-in-out, max-width 0.3s ease-in-out, padding 0.3s ease-in-out, background-color 0.3s ease-in-out;
            position: relative;
            background-color: #1F2937; 
            border-radius: 0.5rem; 
        }
        #infoPanelColumn.collapsed {
            flex-basis: 50px;
            min-width: 50px;
            max-width: 50px;
            overflow: hidden;
            background-color: transparent !important;
            border-radius: 0;
        }
        #infoPanelColumn.collapsed #infoPanelTabs,
        #infoPanelColumn.collapsed #infoPanelContentArea {
            display: none;
        }

        #toggleInfoPanelButton {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 20;
            background-color: rgba(49, 51, 56, 0.8);
            color: white;
            border: 1px solid #4A5568;
            border-radius: 0.375rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: left 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #infoPanelColumn.collapsed #toggleInfoPanelButton {
            left: 50%;
            transform: translateX(-50%);
        }
        #infoPanelColumn.collapsed #toggleInfoPanelButton .fa-chevron-left { display: none; }
        #infoPanelColumn.collapsed #toggleInfoPanelButton .fa-chevron-right { display: inline-block; }
        #infoPanelColumn:not(.collapsed) #toggleInfoPanelButton .fa-chevron-left { display: inline-block; }
        #infoPanelColumn:not(.collapsed) #toggleInfoPanelButton .fa-chevron-right { display: none; }


        #infoPanelTabs {
            display: flex;
            flex-wrap: wrap; 
            padding: 0.25rem;
            background-color: #374151; 
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            margin-top: 45px;
            flex-shrink: 0;
        }
        .info-tab-button {
            padding: 0.5rem 0.75rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem; 
            border-radius: 0.375rem;
            background-color: #4B5563; 
            color: #D1D5DB; 
            font-weight: 500;
            font-size: 0.875rem; 
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .info-tab-button:hover {
            background-color: #6B7280; 
        }
        .info-tab-button.active-tab {
            background-color: #10B981; 
            color: white;
        }

        #infoPanelContentArea {
            flex-grow: 1; 
            background-color: #374151; 
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column; 
            min-height: 0;
        }
        .info-content-panel {
            display: none;
            width: 100%;
            overflow-y: auto; 
            color: #E5E7EB; 
            padding: 1rem; 
        }
        .info-content-panel.active-content {
            display: flex; 
            flex-direction: column; 
            flex-grow: 1; 
            min-height: 0;
        }
        
        #mapContent, #codeDisplayContent, #calculatorContent {
            padding: 0; 
        }
        #searchContent, #emailContent, #taskContent, #calendarContent, #weatherForecastContent, #schedulerContent {
             padding: 1rem;
        }

        #mapDiv { 
            height: 100%;
            width: 100%;
        }
        
        #searchResultsContent h3, #emailListContent h3, #taskListContent h3, #calendarEventListContent h3, #weatherForecastDisplay h3, #promptScheduler h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #F3F4F6;
            border-bottom: 1px solid #4B5563;
            padding-bottom: 0.5rem;
        }

        #searchResultsContent a, .task-item a, .calendar-event-item a { color: #60A5FA; }
        #searchResultsContent a:hover, .task-item a:hover, .calendar-event-item a:hover { text-decoration: underline; }
        .task-item, .calendar-event-item, #scheduledPromptsList li {
            padding: 0.75rem;
            background-color: #4B5563;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .task-item strong, .calendar-event-item strong { color: #93C5FD; }
        .task-notes, .calendar-event-time { font-size: 0.75rem; color: #D1D5DB; margin-top: 0.25rem; }

        
        #weatherForecastDisplay .forecast-day {
            background-color: #4B5563; 
            border-radius: 0.375rem; 
            padding: 0.75rem; 
            margin-bottom: 0.75rem; 
        }
        #weatherForecastDisplay .forecast-day h4 { font-size: 1rem; font-weight: 600; color: #E5E7EB; margin-bottom: 0.5rem; }
        #weatherForecastDisplay .forecast-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #5A6676; font-size: 0.875rem; }
        #weatherForecastDisplay .forecast-item:last-child { border-bottom: none; }
        #weatherForecastDisplay .forecast-item .time { color: #D1D5DB; width: 15%;}
        #weatherForecastDisplay .forecast-item .icon { width: 10%; text-align: center; font-size: 1.25rem; }
        #weatherForecastDisplay .forecast-item .temp { color: #F3F4F6; font-weight: 500; width: 15%; text-align: right; }
        #weatherForecastDisplay .forecast-item .desc { color: #CBD5E1; flex-grow: 1; padding-left: 0.5rem; text-align: left; }
        #weatherForecastDisplay .forecast-item .wind, #weatherForecastDisplay .forecast-item .humidity { color: #9CA3AF; font-size: 0.75rem; width: 20%; text-align: right; }


        #chatColumn {
            flex: 1; 
            max-width: 42rem; 
            display: flex;
            flex-direction: column;
        }

        .listening-indicator { width: 122px; height: 122px; border-radius: 50%; background-color: #10B981; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 0 0 rgba(16, 185, 129, 1); }
        .listening-indicator.active { animation: pulse 1.5s infinite; }
        .listening-indicator.speaking { animation: speak-pulse 1s infinite; }
        .listening-indicator-inner { width: 40px; height: 40px; border-radius: 50%; background-color: #D1FAE5; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes speak-pulse { 0% { transform: scale(1); background-color: #6EE7B7; } 50% { transform: scale(1.1); background-color: #10B981; } 100% { transform: scale(1); background-color: #6EE7B7; } }
        #webcamVideo { object-fit: cover; border-radius: 50%; width: 150px; height: 150px; transition: transform 0.3s; }
        #webcamVideo.mirrored { transform: scaleX(-1); }
        
        #chatbox { 
            scroll-behavior: smooth;
            height: 550px; /* MODIFICATION: Hauteur fixe pour la chatbox */
            overflow-y: auto; 
        }
        .user-message { text-align: right; margin-left: auto; background-color: #3B82F6; color: white; }
        .assistant-message { text-align: left; margin-right: auto; background-color: #4B5563; color: white; }
        #snapshotCanvas { display: none; }

        #codeDisplayContent #evaCodeCanvasContainer { height: 100%; display: flex; flex-direction: column; }
        #codeDisplayContent #evaCodeCanvasContainer .bg-gray-800 { background-color: #374151; }
        #evaCodeCanvasContentWrapper { overflow-y: auto; transition: opacity 0.5s ease-in-out; background-color: #1e1e1e; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; flex-grow: 1; padding: 1rem; height: 0; opacity: 0; }
        #evaCodeCanvasContentWrapper.expanded { opacity: 1; min-height: 0; }
        #evaCodeCanvasContentCode { color: #d4d4d4; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; display: block; }
        
        #schedulerContent #promptScheduler { width: 100%; }
        #schedulerContent #promptScheduler label { margin-top: 0.5rem; display: block; color: #D1D5DB; font-size: 0.875rem; }
        #schedulerContent #scheduledPromptsList li { color: #D1D5DB; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; font-size: 0.875rem; gap: 0.25rem; }
        #schedulerContent #scheduledPromptsList .prompt-details { margin-bottom: 0.25rem; }
        #schedulerContent #scheduledPromptsList .prompt-actions button { background-color: #EF4444; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-right: 0.25rem; }
        #schedulerContent #scheduledPromptsList .prompt-actions button:hover { background-color: #DC2626; }
        #schedulerContent #scheduledPromptsList .prompt-actions .pause-prompt-button { background-color: #F59E0B; }
        #schedulerContent #scheduledPromptsList .prompt-actions .pause-prompt-button:hover { background-color: #D97706; }
        #schedulerContent #scheduledPromptsList .prompt-actions .resume-prompt-button { background-color: #10B981; }
        #schedulerContent #scheduledPromptsList .prompt-actions .resume-prompt-button:hover { background-color: #059669; }

        #filePreview { font-size: 0.75rem; color: #9CA3AF; margin-top: 0.5rem; text-align: center; }
        #filePreview img { max-height: 50px; max-width: 100px; border-radius: 0.25rem; margin: 0 auto 0.25rem; display: block; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
        .input-row { display: flex; gap: 0.5rem; align-items: center; }
        .input-row label { margin-top: 0; } 

        #calculatorContainer { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 1rem; box-sizing: border-box; background-color: #2D3748; }
        #calculatorDisplay { width: 100%; max-width: 320px; background-color: #1A202C; color: #E2E8F0; text-align: right; padding: 0.75rem 1rem; font-size: 1.75rem; border-radius: 0.375rem; margin-bottom: 1rem; overflow-x: auto; white-space: nowrap; border: 1px solid #4A5568; min-height: 2.5em; }
        #calculatorButtons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; width: 100%; max-width: 320px; }
        .calc-button { background-color: #4A5568; color: #E2E8F0; border: none; border-radius: 0.375rem; padding: 1rem 0.5rem; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: center; align-items: center; }
        .calc-button:hover { background-color: #718096; }
        .calc-button.operator { background-color: #2B6CB0; color: white; }
        .calc-button.operator:hover { background-color: #3182CE; }
        .calc-button.function { background-color: #9B2C2C; color: white; }
        .calc-button.function:hover { background-color: #C53030; }
        .calc-button.clear { background-color: #B7791F; color: white; }
        .calc-button.clear:hover { background-color: #D69E2E; }
        .calc-button.equals { background-color: #2F855A; color: white; grid-column: span 2; }
        .calc-button.equals:hover { background-color: #38A169; }
        .calc-button.zero { grid-column: span 2; }

        /* --- Styles pour la r√©activit√© mobile --- */
        @media (max-width: 700px) {
            html, body {
                height: auto;
                overflow: auto;
            }
             #mainAppContainer {
                flex-direction: column;
                height: auto;
                align-items: center; 
                padding: 0.5rem; 
                gap: 0.5rem; 
            }
            #infoPanelColumn, #chatColumn {
                width: 100%; 
                flex-basis: auto; 
                max-width: 100%;
                min-width: unset; 
            }
            #infoPanelColumn:not(.collapsed) { height: 60vh; }
            #infoPanelColumn.collapsed { flex-basis: auto; height: 50px; }
            .info-content-panel { padding: 0.75rem; } 
            #mapContent, #codeDisplayContent, #calculatorContent { padding: 0; } 
            #schedulerContent { padding: 0.75rem; } 
            h1.text-6xl { font-size: 2.5rem; margin-top: 1rem; margin-bottom: 1rem; }
            #chatColumn { padding: 0; display: flex; flex-direction: column; flex-grow: 1; }
            #dashboard { padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; }
            #dashboard #timeDisplay { font-size: 1rem; }
            #visualIndicator { width: 100px; height: 100px; margin-bottom: 0.5rem; }
            #listeningIndicator.listening-indicator { width: 100px; height: 100px; }
            #webcamVideo { width: 100px; height: 100px; }
            #listeningIndicator .listening-indicator-inner { width: 35px; height: 35px; }
            @keyframes pulse { 
                70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 
            }
            #statusText { margin-bottom: 0.5rem; font-size: 0.75rem; }
            #chatbox { flex-grow: 1; min-height: 150px; margin-bottom: 0.5rem; }
            .chat-controls-container { flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem; }
            .chat-controls-container > * { margin: 0.25rem; }
            #messageInput { flex-grow: 1; min-width: 150px; padding: 0.5rem; font-size: 0.9rem; }
            .chat-controls-container > button { padding: 0.6rem; font-size: 0.8rem; flex-shrink: 0; }
            #filePreview { margin-bottom: 0.5rem; }
            .input-row { flex-direction: column; align-items: stretch;}
            .input-row input[type="number"], .input-row input[type="checkbox"] { width: 100%;}
            #calculatorButtons { grid-template-columns: repeat(4, 1fr); max-width: 100%;} 
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <h1 class="text-6xl font-bold my-4 text-center shrink-0">„Ö§E.V.A</h1>

    <div id="mainAppContainer">
        <div id="infoPanelColumn">
            <button id="toggleInfoPanelButton" title="Afficher/Masquer Panneau d'Info">
                <i class="fas fa-chevron-left"></i>
                <i class="fas fa-chevron-right" style="display:none;"></i>
            </button>
            <div id="infoPanelTabs">
                <button class="info-tab-button active-tab" data-target="mapContent">Carte</button>
                <button class="info-tab-button" data-target="searchContent">Recherche</button>
                <button class="info-tab-button" data-target="emailContent">Emails</button>
                <button class="info-tab-button" data-target="taskContent">T√¢ches</button>
                <button class="info-tab-button" data-target="calendarContent">Calendrier</button>
                <button class="info-tab-button" data-target="weatherForecastContent">M√©t√©o</button>
                <button class="info-tab-button" data-target="codeDisplayContent">Code</button>
                <button class="info-tab-button" data-target="schedulerContent">Planificateur</button> 
                <button class="info-tab-button" data-target="calculatorContent">Calculatrice</button> 
            </div>
            <div id="infoPanelContentArea">
                <div id="mapContent" class="info-content-panel active-content">
                    <div id="mapDiv"></div>
                </div>
                <div id="searchContent" class="info-content-panel">
                    <div id="searchResultsContent">
                        <h3>R√©sultats de recherche</h3>
                         <p>Effectuez une recherche pour voir les r√©sultats ici.</p>
                    </div>
                </div>
                <div id="emailContent" class="info-content-panel">
                    <div id="emailListContent">
                        <h3>Emails Non Lus</h3>
                        <p>Les emails non lus s'afficheront ici.</p>
                    </div>
                </div>
                <div id="taskContent" class="info-content-panel">
                    <div id="taskListContent">
                        <h3>Liste des T√¢ches</h3>
                        <p>Vos t√¢ches s'afficheront ici.</p>
                    </div>
                </div>
                <div id="calendarContent" class="info-content-panel">
                    <div id="calendarEventListContent">
                        <h3>√âv√©nements du Calendrier</h3>
                        <p>Vos √©v√©nements de calendrier s'afficheront ici.</p>
                    </div>
                </div>
                <div id="weatherForecastContent" class="info-content-panel">
                    <div id="weatherForecastDisplay">
                         <h3>Pr√©visions M√©t√©o</h3>
                         <p>Chargement des pr√©visions...</p>
                    </div>
                </div>
                <div id="codeDisplayContent" class="info-content-panel">
                    <div id="evaCodeCanvasContainer" class="w-full h-full rounded-lg">
                        <div class="flex justify-between items-center p-3 bg-gray-700 rounded-t-lg">
                            <h3 class="text-lg font-semibold text-gray-200 mb-0 border-b-0 pb-0">Code g√©n√©r√© par EVA</h3>
                            <button id="toggleCodeCanvasButton" class="p-2 text-gray-400 hover:text-white rounded-md">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="evaCodeCanvasContentWrapper" class="rounded-b-lg h-full">
                            <pre class="h-full"><code id="evaCodeCanvasContentCode" class="text-sm h-full"></code></pre>
                        </div>
                    </div>
                </div>
                <div id="schedulerContent" class="info-content-panel"> 
                    <div id="promptScheduler" class="w-full">
                        <h3>Planifier un Prompt</h3>
                        <div class="input-group">
                            <input type="text" id="scheduledPromptText" placeholder="Texte du prompt..." class="w-full p-2 bg-gray-600 border border-gray-500 rounded-md text-white placeholder-gray-400">
                        </div>
                        <div class="input-group">
                            <label for="scheduledPromptTime">Date et heure de d√©but :</label>
                            <input type="datetime-local" id="scheduledPromptTime" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-md text-white">
                        </div>
                        
                        <div class="input-group">
                            <label for="promptFrequency">Fr√©quence :</label>
                            <select id="promptFrequency" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-md text-white">
                                <option value="once">Une fois</option>
                                <option value="daily">Quotidien</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="monthly">Mensuel</option>
                            </select>
                        </div>

                        <div id="recurrenceOptions" class="hidden">
                            <div class="input-group">
                                <label for="promptRepetitions">Nombre de r√©p√©titions :</label>
                                <input type="number" id="promptRepetitions" min="1" value="1" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-md text-white">
                            </div>
                            <div class="input-row items-center mt-2">
                                <input type="checkbox" id="promptIndefinite" class="p-2 bg-gray-600 border-gray-500 rounded-md text-white">
                                <label for="promptIndefinite" class="ml-2 text-sm text-gray-300">R√©p√©ter ind√©finiment</label>
                            </div>
                        </div>
                        
                        <button id="schedulePromptButton" class="mt-3 w-full p-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white font-semibold">Planifier</button>
                        
                        <h4 class="mt-4 text-base font-medium text-gray-300">Prompts Planifi√©s :</h4>
                        <ul id="scheduledPromptsList" class="mt-2 space-y-1">
                           </ul>
                    </div>
                </div>
                <div id="calculatorContent" class="info-content-panel"> 
                    <div id="calculatorContainer">
                        <div id="calculatorDisplay">0</div>
                        <div id="calculatorButtons">
                            <button class="calc-button function" data-value="sin">sin</button> <button class="calc-button function" data-value="cos">cos</button> <button class="calc-button function" data-value="tan">tan</button> <button class="calc-button function" data-value="sqrt">‚àö</button> <button class="calc-button function" data-value="^">x ∏</button>
                            <button class="calc-button function" data-value="log">log</button> <button class="calc-button function" data-value="ln">ln</button> <button class="calc-button function" data-value="(">(</button> <button class="calc-button function" data-value=")">)</button> <button class="calc-button clear" data-value="C">C</button>
                            <button class="calc-button" data-value="7">7</button> <button class="calc-button" data-value="8">8</button> <button class="calc-button" data-value="9">9</button> <button class="calc-button operator" data-value="/">√∑</button> <button class="calc-button function" data-value="pi">œÄ</button>
                            <button class="calc-button" data-value="4">4</button> <button class="calc-button" data-value="5">5</button> <button class="calc-button" data-value="6">6</button> <button class="calc-button operator" data-value="*">√ó</button> <button class="calc-button function" data-value="e">e</button>
                            <button class="calc-button" data-value="1">1</button> <button class="calc-button" data-value="2">2</button> <button class="calc-button" data-value="3">3</button> <button class="calc-button operator" data-value="-">‚àí</button> <button class="calc-button function" data-value="!">x!</button>
                            <button class="calc-button zero" data-value="0">0</button> <button class="calc-button" data-value=".">.</button> <button class="calc-button operator" data-value="+">+</button> <button class="calc-button equals" data-value="=">=</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chatColumn">
            <div id="dashboard" class="w-full p-3 mb-4 bg-gray-800 rounded-lg shadow-md text-sm text-gray-300 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <div id="dateDisplay" class="text-center sm:text-left">Chargement date...</div>
                <div id="timeDisplay" class="text-center font-semibold text-lg order-first sm:order-none">Chargement heure...</div>
                <div id="weatherDisplay" class="text-center sm:text-right">
                    <span id="weatherLocation" class="font-medium">Localisation...</span>:
                    <span id="weatherTemp">--¬∞C</span>,
                    <span id="weatherDesc">Chargement m√©t√©o...</span>
                    <span id="weatherIcon" class="ml-1"></span>
                </div>
            </div>

            <div class="flex flex-col items-center flex-grow min-h-0">
                <div id="visualIndicator" class="mb-4 relative flex justify-center items-center" style="width: 150px; height: 150px;">
                    <div id="listeningIndicator" class="listening-indicator absolute">
                        <div class="listening-indicator-inner"></div>
                    </div>
                     <video id="webcamVideo" class="hidden absolute rounded-full" autoplay playsinline></video>
                     <div id="webcamError" class="text-red-500 text-xs hidden absolute bottom-[-20px]">Erreur Webcam</div>
                </div>
                <p id="statusText" class="text-gray-400 mb-4 text-sm">Appuyez sur Espace (continu) ou Micro (unique)</p>
    
                <div id="chatbox" class="w-full bg-gray-800 rounded-lg p-4 mb-4 border border-gray-700 flex flex-col space-y-2">
                    <div class="assistant-message p-2 rounded-lg max-w-xs md:max-w-md">
                         E.V.A Activ√©e. Pour acc√©der aux services Google, veuillez autoriser l'application.
                     </div>
                </div>
            </div>

            <div id="filePreview" class="w-full mb-2"></div> 
            
            <div class="chat-controls-container w-full flex items-center space-x-2 mb-4">
                <button id="micButton" class="p-3 bg-blue-600 hover:bg-blue-700 rounded-full text-white focus:outline-none" title="Activer le microphone (ou dire 'Eva', ou touche 'ESPACE' pour continu)">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" id="messageInput" placeholder="√âcrivez votre message ou utilisez le micro..." class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-400">
                <button id="attachFileButton" class="p-3 bg-teal-500 hover:bg-teal-600 rounded-lg text-white focus:outline-none" title="Joindre un fichier">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" class="hidden" accept="image/*,text/*,.py,.js,.html,.css,.json,.md,audio/*,video/*">
                <button id="sendButton" class="p-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white focus:outline-none" title="Envoyer">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="interruptModeButton" class="p-3 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-white focus:outline-none" title="Activer l'interruption d'EVA (D√©sactiv√©) (ou touche 'i')">
                    <i class="fas fa-comment-slash"></i>
                </button>
                <button id="muteButton" class="p-3 bg-gray-600 hover:bg-gray-700 rounded-lg text-white focus:outline-none" title="Activer/D√©sactiver le son (ou touche 'M')">
                    <i id="muteIcon" class="fas fa-volume-up"></i>
                </button>
                <button id="camButton" class="p-3 bg-gray-600 hover:bg-gray-700 rounded-lg text-white focus:outline-none" title="Activer/D√©sactiver la cam√©ra (ou touche 'C')">
                    <i id="camIcon" class="fas fa-video-slash"></i>
                </button>
                <button id="switchCamButton" class="p-3 bg-teal-500 hover:bg-teal-600 rounded-lg text-white focus:outline-none hidden" title="Changer de cam√©ra">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="authorizeGoogleButton" class="p-3 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold focus:outline-none" title="Autoriser l'acc√®s aux services Google">
                    <i class="fab fa-google"></i>
                </button>
            </div>
            <p id="authStatus" class="text-xs text-center text-gray-500 mb-2"></p>
        </div>
    </div>

    <audio id="audioPlayer" class="hidden"></audio>
    <canvas id="snapshotCanvas" class="hidden"></canvas>

    <script>
        // --- DOM Elements ---
        const authorizeGoogleButton = document.getElementById('authorizeGoogleButton');
        const authStatus = document.getElementById('authStatus');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');
        const muteButton = document.getElementById('muteButton');
        const camButton = document.getElementById('camButton');
        const switchCamButton = document.getElementById('switchCamButton');
        const chatbox = document.getElementById('chatbox');
        const statusText = document.getElementById('statusText');
        const audioPlayer = document.getElementById('audioPlayer');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const webcamVideo = document.getElementById('webcamVideo');
        const webcamError = document.getElementById('webcamError');
        const snapshotCanvas = document.getElementById('snapshotCanvas');
        const interruptModeButton = document.getElementById('interruptModeButton'); 
        const muteIcon = document.getElementById('muteIcon');
        const camIcon = document.getElementById('camIcon');
        const scheduledPromptTextInput = document.getElementById('scheduledPromptText');
        const scheduledPromptTimeInput = document.getElementById('scheduledPromptTime');
        const schedulePromptButton = document.getElementById('schedulePromptButton');
        const scheduledPromptsListUI = document.getElementById('scheduledPromptsList');
        const promptFrequencyInput = document.getElementById('promptFrequency');
        const recurrenceOptionsDiv = document.getElementById('recurrenceOptions');
        const promptRepetitionsInput = document.getElementById('promptRepetitions');
        const promptIndefiniteCheckbox = document.getElementById('promptIndefinite');
        const attachFileButton = document.getElementById('attachFileButton');
        const fileInput = document.getElementById('fileInput');
        const filePreviewContainer = document.getElementById('filePreview');
        const infoPanelColumn = document.getElementById('infoPanelColumn');
        const toggleInfoPanelButton = document.getElementById('toggleInfoPanelButton');
        const infoPanelTabsContainer = document.getElementById('infoPanelTabs');
        const mapElementDiv = document.getElementById('mapDiv'); 
        const searchResultsContentDiv = document.getElementById('searchResultsContent');
        const emailListContentDiv = document.getElementById('emailListContent');
        const taskListContentDiv = document.getElementById('taskListContent');
        const calendarEventListContentDiv = document.getElementById('calendarEventListContent');
        const weatherForecastDisplayDiv = document.getElementById('weatherForecastDisplay');
        const evaCodeCanvasContainer = document.getElementById('evaCodeCanvasContainer');
        const toggleCodeCanvasButton = document.getElementById('toggleCodeCanvasButton');
        const evaCodeCanvasContentWrapper = document.getElementById('evaCodeCanvasContentWrapper');
        const evaCodeCanvasContentCode = document.getElementById('evaCodeCanvasContentCode');
        const codeCanvasIcon = toggleCodeCanvasButton.querySelector('i');
        const calculatorDisplay = document.getElementById('calculatorDisplay');
        const calculatorButtonsContainer = document.getElementById('calculatorButtons'); 
        let calculatorCurrentInput = "";
        let calculatorOperator = null;
        let calculatorPreviousInput = "";
        let calculatorResetDisplay = false;
        const MAX_INPUT_LENGTH = 20; 

        // --- Backend URL ---
        const backendHttpUrl = 'http://localhost:5000'; 
        const backendWsUrl = 'ws://localhost:5000/api/chat_ws'; 

        // --- WebSocket ---
        let ws = null;
        let wsReady = false;
        let wsRetryInterval = 5000;

        // --- Google Maps Variables ---
        let gMap; 
        let directionsService;
        let directionsRenderer;
        const defaultMapCenter = { lat: 48.8566, lng: 2.3522 }; 
        let currentMapCenter = defaultMapCenter;
        let currentMapZoom = 12;
        let activeInfoPanelId = 'mapContent'; 
        let userLocatedCity = "Thonon-les-Bains"; 
        let userLatitude = null;
        let userLongitude = null;

        // --- Application State ---
        let isMuted = false;
        let isCamOn = false;
        let availableCameras = [];
        let currentCameraIndex = 0;
        let commandRecognizer = null; 
        let wakeWordRecognizer = null; 
        let mediaStream = null; 
        let userExplicitlyWantsContinuousListen = false; 
        let recognitionActive = false; 
        let wakeWordRecognitionActive = false; 
        let isEvaActivatedListening = false; 
        let pausedForEvaOutput = false; 
        let skipNextAudioDueToCode = false; 
        let isSpeakingClientSide = false; 
        let interruptEvaEnabled = false; 
        let evaIsCurrentlySpeaking = false; 
        let scheduledPrompts = []; 
        let attachedFile = null; 

        // --- OpenWeatherMap API Key ---
        const openWeatherMapApiKey = 'YOUR_OPENWEATHERMAP_API_KEY'; 

        // --- Audio Context for Sounds ---
        let audioCtx;
        function initAudioContext() { if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } }
        function playBeep(frequency = 440, duration = 100, type = 'sine', volume = 0.05) {
            if (isMuted) return; if (!audioCtx) initAudioContext(); if (!audioCtx) { console.warn("AudioContext non support√©."); return; }
            if (audioCtx.state === 'suspended') { audioCtx.resume().then(() => { actuallyPlayBeep(frequency, duration, type, volume); }).catch(e => console.error("Erreur reprise AudioContext:", e)); } else { actuallyPlayBeep(frequency, duration, type, volume); }
        }
        function actuallyPlayBeep(frequency, duration, type, volume) {
            const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            oscillator.type = type; oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + duration * 0.0001); gainNode.gain.setValueAtTime(volume, audioCtx.currentTime + duration * 0.0008); gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration * 0.001); 
            oscillator.start(audioCtx.currentTime); oscillator.stop(audioCtx.currentTime + duration / 1000);
        }
        const evaActivationSound = () => playBeep(880, 100, 'sine', 0.03); 
        const cameraToggleSound = () => playBeep(440, 150, 'sine', 0.04);  

        // --- Dashboard Functions ---
        function updateDateTimeDashboard() {
            const dateDisplay = document.getElementById('dateDisplay'); const timeDisplay = document.getElementById('timeDisplay'); if (!dateDisplay || !timeDisplay) return; 
            const now = new Date();
            dateDisplay.textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            timeDisplay.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Europe/Paris' });
        }
        async function fetchWeatherDashboard(latitude, longitude) {
            const weatherLocationEl = document.getElementById('weatherLocation'); const weatherTempEl = document.getElementById('weatherTemp'); const weatherDescEl = document.getElementById('weatherDesc'); const weatherIconEl = document.getElementById('weatherIcon'); if (!weatherLocationEl || !weatherTempEl || !weatherDescEl || !weatherIconEl) return;
            const lang = 'fr'; const units = 'metric'; let apiUrl;
            if (openWeatherMapApiKey === 'YOUR_OPENWEATHERMAP_API_KEY' || !openWeatherMapApiKey) { weatherDescEl.textContent = "Config. API requise"; weatherLocationEl.textContent = "N/A"; weatherTempEl.textContent = ""; weatherIconEl.textContent = "‚öôÔ∏è"; return; }
            if (latitude && longitude) { apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${openWeatherMapApiKey}&lang=${lang}&units=${units}`; } else { apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${userLocatedCity}&appid=${openWeatherMapApiKey}&lang=${lang}&units=${units}`; }
            try {
                const response = await fetch(apiUrl); if (!response.ok) throw new Error(`Erreur API M√©t√©o: ${response.status}`);
                const data = await response.json();
                weatherLocationEl.textContent = data.name; weatherTempEl.textContent = `${Math.round(data.main.temp)}¬∞C`; weatherDescEl.textContent = data.weather[0].description; weatherIconEl.textContent = getWeatherEmoji(data.weather[0].icon);
            } catch (error) { console.error("Erreur m√©t√©o:", error); if (weatherLocationEl) weatherLocationEl.textContent = userLocatedCity; if (weatherDescEl) weatherDescEl.textContent = "M√©t√©o indisponible"; if (weatherTempEl) weatherTempEl.textContent = ""; if (weatherIconEl) weatherIconEl.textContent = "‚ö†Ô∏è"; }
        }
        function getWeatherEmoji(iconCode) { const emojiMap = { "01d": "‚òÄÔ∏è", "01n": "üåë", "02d": "‚õÖ", "02n": "‚òÅÔ∏è", "03d": "‚òÅÔ∏è", "03n": "‚òÅÔ∏è", "04d": "‚òÅÔ∏è", "04n": "‚òÅÔ∏è", "09d": "üåßÔ∏è", "09n": "üåßÔ∏è", "10d": "üå¶Ô∏è", "10n": "üåßÔ∏è", "11d": "‚õàÔ∏è", "11n": "‚õàÔ∏è", "13d": "‚ùÑÔ∏è", "13n": "‚ùÑÔ∏è", "50d": "üå´Ô∏è", "50n": "üå´Ô∏è" }; return emojiMap[iconCode] || "‚ùì"; }
        function getUserLocationAndFetchWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLatitude = position.coords.latitude; userLongitude = position.coords.longitude;
                        if (openWeatherMapApiKey !== 'YOUR_OPENWEATHERMAP_API_KEY' && openWeatherMapApiKey) {
                            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${userLatitude}&lon=${userLongitude}&appid=${openWeatherMapApiKey}&lang=fr&units=metric`)
                                .then(response => response.json()).then(data => { if (data.name) userLocatedCity = data.name; fetchWeatherDashboard(userLatitude, userLongitude); })
                                .catch(err => { console.warn("Erreur r√©cup√©ration nom ville:", err); fetchWeatherDashboard(userLatitude, userLongitude); });
                        } else { fetchWeatherDashboard(userLatitude, userLongitude); }
                    },
                    (error) => { console.warn("Erreur g√©olocalisation:", error.message); userLatitude = null; userLongitude = null; fetchWeatherDashboard(); }
                );
            } else { console.warn("G√©olocalisation non support√©e."); userLatitude = null; userLongitude = null; fetchWeatherDashboard(); }
        }
        async function displayWeatherForecast() {
            setActiveInfoPanel('weatherForecastContent', true); weatherForecastDisplayDiv.innerHTML = `<h3>Pr√©visions M√©t√©o pour ${userLocatedCity || 'votre position'}</h3><p>Chargement...</p>`;
            if (openWeatherMapApiKey === 'YOUR_OPENWEATHERMAP_API_KEY' || !openWeatherMapApiKey) { weatherForecastDisplayDiv.innerHTML = `<h3>Pr√©visions M√©t√©o</h3><p class="text-red-400">Cl√© API OpenWeatherMap non configur√©e.</p>`; return; }
            let forecastApiUrl; const lang = 'fr'; const units = 'metric'; const cnt = 40; 
            if (userLatitude && userLongitude) { forecastApiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${userLatitude}&lon=${userLongitude}&appid=${openWeatherMapApiKey}&lang=${lang}&units=${units}&cnt=${cnt}`; } else if (userLocatedCity) { forecastApiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${userLocatedCity}&appid=${openWeatherMapApiKey}&lang=${lang}&units=${units}&cnt=${cnt}`; } else { weatherForecastDisplayDiv.innerHTML = `<h3>Pr√©visions M√©t√©o</h3><p>Localisation non disponible.</p>`; return; }
            try {
                const response = await fetch(forecastApiUrl); if (!response.ok) { const errorData = await response.json(); throw new Error(`Erreur API Pr√©visions: ${response.status} - ${errorData.message || 'Erreur'}`); }
                const data = await response.json(); if (!data.list || data.list.length === 0) { weatherForecastDisplayDiv.innerHTML = `<h3>Pr√©visions M√©t√©o pour ${data.city.name}</h3><p>Aucune donn√©e.</p>`; return; }
                let html = `<h3>Pr√©visions M√©t√©o pour ${data.city.name}</h3>`; const forecastsByDay = {};
                data.list.forEach(item => { const date = new Date(item.dt * 1000); const dayKey = date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); if (!forecastsByDay[dayKey]) forecastsByDay[dayKey] = []; forecastsByDay[dayKey].push(item); });
                for (const day in forecastsByDay) {
                    html += `<div class="forecast-day"><h4>${day}</h4>`;
                    forecastsByDay[day].forEach(item => {
                        const time = new Date(item.dt * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        html += `<div class="forecast-item"><span class="time">${time}</span><span class="icon">${getWeatherEmoji(item.weather[0].icon)}</span><span class="desc">${item.weather[0].description}</span><span class="temp">${Math.round(item.main.temp)}¬∞C</span><span class="humidity">üíß ${item.main.humidity}%</span><span class="wind">üí® ${Math.round(item.wind.speed * 3.6)} km/h</span></div>`; 
                    });
                    html += `</div>`;
                }
                weatherForecastDisplayDiv.innerHTML = html;
            } catch (error) { console.error("Erreur pr√©visions m√©t√©o:", error); weatherForecastDisplayDiv.innerHTML = `<h3>Pr√©visions M√©t√©o</h3><p class="text-red-400">Impossible de charger: ${error.message}</p>`; }
        }

        // --- Speech Recognition ---
        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        function updateMicButtonState(isListening) {
            if (isListening) { micButton.classList.add('bg-red-600', 'hover:bg-red-700'); micButton.classList.remove('bg-blue-600', 'hover:bg-blue-700'); micButton.innerHTML = '<i class="fas fa-stop"></i>'; listeningIndicator.classList.add('active'); } 
            else { micButton.classList.remove('bg-red-600', 'hover:bg-red-700'); micButton.classList.add('bg-blue-600', 'hover:bg-blue-700'); micButton.innerHTML = '<i class="fas fa-microphone"></i>'; listeningIndicator.classList.remove('active'); }
        }
        function stopAllRecognitions() {
            if (wakeWordRecognizer && wakeWordRecognitionActive) { wakeWordRecognizer.abort(); wakeWordRecognitionActive = false; }
            if (commandRecognizer && recognitionActive) { commandRecognizer.abort(); recognitionActive = false; }
            updateMicButtonState(false); 
        }
        function startWakeWordRecognition() {
            if (!SpeechRecognitionAPI) { statusText.textContent = "Reconnaissance vocale non support√©e."; if(micButton) micButton.disabled = true; return; } if (wakeWordRecognitionActive || recognitionActive) return; 
            stopAllRecognitions(); 
            wakeWordRecognizer = new SpeechRecognitionAPI(); wakeWordRecognizer.lang = 'fr-FR'; wakeWordRecognizer.continuous = true; wakeWordRecognizer.interimResults = true; 
            wakeWordRecognizer.onstart = () => { wakeWordRecognitionActive = true; updateMicButtonState(false); statusText.textContent = "Dites 'OK Eva' pour activer, ou Espace pour continu."; console.log("Reco. mot-cl√© d√©marr√©e."); };
            wakeWordRecognizer.onresult = (event) => { for (let i = event.resultIndex; i < event.results.length; ++i) { const transcript = event.results[i][0].transcript.toLowerCase().trim(); if (event.results[i].isFinal || transcript.includes("ok eva")) { if (transcript.includes("ok eva")) { console.log("Mot-cl√© 'Eva' d√©tect√©."); evaActivationSound(); stopWakeWordRecognition(); isEvaActivatedListening = true; userExplicitlyWantsContinuousListen = false; startCommandRecognition(false); return; } } } };
            wakeWordRecognizer.onerror = (event) => {
                wakeWordRecognitionActive = false; updateMicButtonState(false); let errorMsg = `Erreur reco. mot-cl√©: ${event.error}`;
                if (event.error === 'no-speech') errorMsg = 'Aucune parole (mot-cl√©).'; else if (event.error === 'audio-capture') errorMsg = 'Erreur capture audio (mot-cl√©).'; else if (event.error === 'not-allowed') errorMsg = 'Acc√®s micro refus√© (mot-cl√©).';
                statusText.textContent = errorMsg; console.error("Erreur reco. mot-cl√©:", event.error);
                if (event.error !== 'not-allowed' && event.error !== 'aborted' && !recognitionActive) { setTimeout(startWakeWordRecognition, 250); } else { statusText.textContent = errorMsg + " R√©essayez ou v√©rifiez permissions."; }
            };
            wakeWordRecognizer.onend = () => { const wasActive = wakeWordRecognitionActive; wakeWordRecognitionActive = false; console.log("Reco. mot-cl√© termin√©e."); if (wasActive && !recognitionActive && !isEvaActivatedListening) { console.log("Red√©marrage reco. mot-cl√©."); setTimeout(startWakeWordRecognition, 50); } else { updateMicButtonState(recognitionActive); } };
            try { wakeWordRecognizer.start(); } catch (e) { wakeWordRecognitionActive = false; updateMicButtonState(false); statusText.textContent = "Erreur d√©marrage reco. mot-cl√©."; console.error("Erreur d√©marrage reco. mot-cl√©:", e); }
        }
        function stopWakeWordRecognition() { if (wakeWordRecognizer && wakeWordRecognitionActive) { wakeWordRecognizer.abort(); } wakeWordRecognitionActive = false; }
        function startCommandRecognition(isContinuous) {
            if (!SpeechRecognitionAPI) { statusText.textContent = "Reconnaissance vocale non support√©e."; if(micButton) micButton.disabled = true; return; } if (recognitionActive) { console.warn("Reco. commande d√©j√† active."); return; }
            stopWakeWordRecognition(); 
            commandRecognizer = new SpeechRecognitionAPI(); commandRecognizer.lang = 'fr-FR'; commandRecognizer.interimResults = false; commandRecognizer.maxAlternatives = 1; commandRecognizer.continuous = isContinuous || interruptEvaEnabled; 
            commandRecognizer.onstart = () => {
                recognitionActive = true; updateMicButtonState(true); 
                if (isEvaActivatedListening) { statusText.textContent = "Eva activ√©e. √âcoute de la commande..."; } else if (commandRecognizer.continuous) { statusText.textContent = interruptEvaEnabled ? "Interruption d'EVA..." : '√âcoute continue...'; } else { statusText.textContent = '√âcoute...'; }
                 console.log("Reco. commande d√©marr√©e. Continu:", commandRecognizer.continuous, "EvaActiv√©e:", isEvaActivatedListening);
                if (interruptEvaEnabled && evaIsCurrentlySpeaking) { if (audioPlayer && !audioPlayer.paused) audioPlayer.pause(); if (speechSynthesis.speaking) speechSynthesis.cancel(); }
            };
            commandRecognizer.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase(); console.log("Commande reconnue:", transcript);
                let commandProcessedLocally = false;
                if (transcript === "allume la cam√©ra") { if (!isCamOn) { toggleWebcam(); } else { addMessageToChat("La cam√©ra est d√©j√† allum√©e.", "assistant"); } commandProcessedLocally = true; } 
                else if (transcript === "√©teins la cam√©ra") { if (isCamOn) { toggleWebcam(); } else { addMessageToChat("La cam√©ra est d√©j√† √©teinte.", "assistant"); } commandProcessedLocally = true; }
                if (!commandProcessedLocally) { sendMessageViaWebSocket(event.results[event.results.length - 1][0].transcript.trim()); }
            };
            commandRecognizer.onerror = (event) => {
                const wasRecognizingBeforeError = recognitionActive; recognitionActive = false; updateMicButtonState(false);
                let errorMsg = `Erreur reco. cmd: ${event.error}`;
                if (event.error === 'no-speech') errorMsg = 'Aucune parole (commande).'; else if (event.error === 'audio-capture') errorMsg = 'Erreur capture audio (commande).'; else if (event.error === 'not-allowed') { errorMsg = 'Acc√®s micro refus√© (commande).'; userExplicitlyWantsContinuousListen = false; isEvaActivatedListening = false; }
                statusText.textContent = errorMsg; console.error("Erreur reco. commande:", event.error, " EvaActiv√©e:", isEvaActivatedListening, " Continu:", userExplicitlyWantsContinuousListen);
                if (isEvaActivatedListening) { isEvaActivatedListening = false; if (event.error !== 'not-allowed') setTimeout(startWakeWordRecognition, 100); } 
                else if ((userExplicitlyWantsContinuousListen || interruptEvaEnabled) && wasRecognizingBeforeError && event.error !== 'not-allowed' && event.error !== 'aborted') { setTimeout(() => startCommandRecognition(true), 250); } 
                else { if (event.error !== 'not-allowed' && !userExplicitlyWantsContinuousListen && !interruptEvaEnabled) { setTimeout(startWakeWordRecognition, 100); } else if (event.error === 'not-allowed') { statusText.textContent = errorMsg + " V√©rifiez les permissions."; } }
            };
            commandRecognizer.onend = () => {
                const wasActive = recognitionActive; recognitionActive = false; console.log("Reco. commande termin√©e. EvaActiv√©e:", isEvaActivatedListening, "Continu:", userExplicitlyWantsContinuousListen, "Interrupt:", interruptEvaEnabled);
                if (pausedForEvaOutput && !interruptEvaEnabled) { statusText.textContent = "En attente d'EVA..."; } 
                else if (isEvaActivatedListening) { isEvaActivatedListening = false; updateMicButtonState(false); startWakeWordRecognition(); } 
                else if ((userExplicitlyWantsContinuousListen || interruptEvaEnabled) && wasActive) { if (userExplicitlyWantsContinuousListen || interruptEvaEnabled) { console.log("Red√©marrage reco. continue."); startCommandRecognition(true); } else { updateMicButtonState(false); startWakeWordRecognition(); } } 
                else { updateMicButtonState(false); if (!userExplicitlyWantsContinuousListen && !interruptEvaEnabled) { startWakeWordRecognition(); } }
            };
            try { commandRecognizer.start(); } catch (e) { recognitionActive = false; updateMicButtonState(false); statusText.textContent = "Erreur d√©marrage reco. commande."; console.error("Erreur d√©marrage reco. commande:", e); if (isEvaActivatedListening) isEvaActivatedListening = false; startWakeWordRecognition(); }
        }
        function stopCommandRecognition() { if (commandRecognizer && recognitionActive) { commandRecognizer.abort(); } recognitionActive = false; isEvaActivatedListening = false; updateMicButtonState(false); }
        
        // --- Info Panel Management ---
        function setActiveInfoPanel(targetPanelId, autoOpenPanel = true) {
            if (autoOpenPanel && infoPanelColumn.classList.contains('collapsed')) { infoPanelColumn.classList.remove('collapsed'); const leftIcon = toggleInfoPanelButton.querySelector('.fa-chevron-left'); const rightIcon = toggleInfoPanelButton.querySelector('.fa-chevron-right'); if(leftIcon) leftIcon.style.display = 'inline-block'; if(rightIcon) rightIcon.style.display = 'none'; }
            document.querySelectorAll('.info-tab-button').forEach(button => { button.classList.remove('active-tab'); if (button.dataset.target === targetPanelId) button.classList.add('active-tab'); });
            document.querySelectorAll('.info-content-panel').forEach(panel => { panel.classList.remove('active-content'); if (panel.id === targetPanelId) panel.classList.add('active-content'); });
            activeInfoPanelId = targetPanelId; 
            if (targetPanelId === 'mapContent' && typeof google !== 'undefined' && google.maps && gMap) { setTimeout(() => { google.maps.event.trigger(gMap, 'resize'); gMap.setCenter(currentMapCenter); gMap.setZoom(currentMapZoom); }, 350); }
        }
        
        // --- Google Maps Functions ---
        window.initMap = function() {
            const apiKeyScriptTag = document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]'); const apiKeyFromScript = apiKeyScriptTag ? new URL(apiKeyScriptTag.src).searchParams.get('key') : null;
            if (!apiKeyFromScript || apiKeyFromScript === "YOUR_Maps_API_KEY" || !apiKeyFromScript.startsWith("AIza")) { if (mapElementDiv) mapElementDiv.innerHTML = "<p class='p-4 text-red-400'>Configuration de la cl√© API Google Maps incorrecte ou manquante.</p>"; console.error("Cl√© API Google Maps manquante ou invalide."); return; }
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') { addMessageToChat("Erreur: API Google Maps non charg√©e.", "assistant"); return; }
            try {
                directionsService = new google.maps.DirectionsService(); directionsRenderer = new google.maps.DirectionsRenderer();
                gMap = new google.maps.Map(mapElementDiv, { center: currentMapCenter, zoom: currentMapZoom, mapTypeId: google.maps.MapTypeId.ROADMAP, styles: [ {elementType:"geometry",stylers:[{color:"#242f3e"}]},{elementType:"labels.text.stroke",stylers:[{color:"#242f3e"}]},{elementType:"labels.text.fill",stylers:[{color:"#746855"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#263c3f"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#6b9a76"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#38414e"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#212a37"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#9ca5b3"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#746855"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#1f2835"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#f3d19c"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#2f3948"}]},{featureType:"transit.station",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#17263c"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#515c6d"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{color:"#17263c"}]}] });
                directionsRenderer.setMap(gMap); 
                gMap.addListener('center_changed', () => { if(gMap) currentMapCenter = gMap.getCenter(); }); gMap.addListener('zoom_changed', () => { if(gMap) currentMapZoom = gMap.getZoom(); }); 
                if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( (position) => { if(gMap) { const userPos = { lat: position.coords.latitude, lng: position.coords.longitude }; gMap.setCenter(userPos); currentMapCenter = userPos;} }, () => { console.warn("Impossible d'obtenir la position."); } ); }
            } catch (e) { addMessageToChat("Erreur init carte.", "assistant"); console.error("Erreur init carte:", e); }
        }
        function calculateAndDisplayRoute(origin, destination) {
            if (!directionsService || !directionsRenderer || !gMap) { addMessageToChat("Services carte non pr√™ts.", "assistant"); setActiveInfoPanel('mapContent', true); return; } if (!origin || !destination) { addMessageToChat("Origine/destination manquante.", "assistant"); setActiveInfoPanel('mapContent', true); return; }
            let originForMap = origin;
            if (typeof origin === 'string' && (origin.toLowerCase().includes("votre position") || origin.toLowerCase().includes("ma position") || origin.toLowerCase().includes("actuelle"))) {
                if (userLatitude && userLongitude) { const userCurrentPos = { lat: userLatitude, lng: userLongitude }; directionsService.route( { origin: userCurrentPos, destination: destination, travelMode: google.maps.TravelMode.DRIVING }, (response, status) => { if (status === google.maps.DirectionsStatus.OK) directionsRenderer.setDirections(response); else addMessageToChat("Impossible d'afficher itin√©raire: " + status, "assistant"); } ); return; } 
                else if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(position => { const userCurrentPos = { lat: position.coords.latitude, lng: position.coords.longitude }; directionsService.route( { origin: userCurrentPos, destination: destination, travelMode: google.maps.TravelMode.DRIVING }, (response, status) => { if (status === google.maps.DirectionsStatus.OK) directionsRenderer.setDirections(response); else addMessageToChat("Impossible d'afficher itin√©raire: " + status, "assistant"); } ); }, () => { addMessageToChat("Impossible d'obtenir position. Utilisation de " + userLocatedCity + ".", "assistant"); directionsService.route( { origin: userLocatedCity, destination: destination, travelMode: google.maps.TravelMode.DRIVING }, (response, status) => { if (status === google.maps.DirectionsStatus.OK) directionsRenderer.setDirections(response); else addMessageToChat("Impossible d'afficher itin√©raire: " + status, "assistant"); }); }); return; } 
                else { addMessageToChat("G√©olocalisation non support√©e. Utilisation de " + userLocatedCity + ".", "assistant"); originForMap = userLocatedCity; }
            }
            directionsService.route( { origin: originForMap, destination: destination, travelMode: google.maps.TravelMode.DRIVING }, (response, status) => { if (status === google.maps.DirectionsStatus.OK) directionsRenderer.setDirections(response); else addMessageToChat("Impossible d'afficher itin√©raire: " + status, "assistant"); } );
        }
        function parseDirectionsFromText(textResponse) { const match = textResponse.match(/^Itin√©raire de\s+(.+?)\s+√†\s+(.+?):/i); if (match && match[1] && match[2]) return { origin: match[1].trim(), destination: match[2].trim() }; return null; }

        // --- Chat & Content Formatting Functions ---
        function addMessageToChat(text, sender) { const messageElement = document.createElement('div'); messageElement.textContent = text; messageElement.classList.add('p-2', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'mb-2', 'break-words'); if (sender === 'user') messageElement.classList.add('user-message'); else messageElement.classList.add('assistant-message'); chatbox.appendChild(messageElement); chatbox.scrollTop = chatbox.scrollHeight; }
        function formatSearchResults(rawText) { let html = `<h3>R√©sultats de recherche</h3>`; const queryMatch = rawText.match(/(?:R√©sultats web pour|R√©ponse directe pour|Information pour)\s+'([^']+)'/i); if (queryMatch && queryMatch[1]) html = `<h3>R√©sultats pour : <span class="italic">${queryMatch[1]}</span></h3>`; const mainContent = queryMatch ? rawText.substring(rawText.indexOf(':') + 1).trim() : rawText; const parts = mainContent.split(/\n\s*\n/); parts.forEach(part => { const lines = part.split('\n').map(l => l.trim()).filter(l => l); if (lines.length === 0) return; if (lines[0].match(/^\d+\.\s+/)) { const title = lines[0].substring(lines[0].indexOf(' ') + 1); const snippet = (lines.find(l => l.toLowerCase().startsWith("extrait:")) || "").substring(8).trim(); const source = (lines.find(l => l.toLowerCase().startsWith("source:")) || "").substring(7).trim() || "#"; html += `<div class="mb-4 p-3 bg-gray-600 rounded-md shadow"><h4 class="font-semibold text-blue-300 text-md mb-1"><a href="${source}" target="_blank" rel="noopener noreferrer">${title}</a></h4>${snippet ? `<p class="text-sm text-gray-200 mb-1">${snippet}</p>` : ''}<p class="text-xs text-gray-400 truncate"><a href="${source}" target="_blank" rel="noopener noreferrer">${source}</a></p></div>`; } else if (lines.length > 0) { html += `<div class="mb-4 p-3 bg-gray-600 rounded-md shadow"><p class="text-sm text-gray-200">${lines.join('<br>')}</p></div>`; } }); return html; }
        function formatEmailList(rawText) { let html = `<h3>Emails Non Lus</h3>`; const lines = rawText.split('\n'); if (lines.length > 1 && lines[0].toLowerCase().includes("voici vos derniers e-mails non lus")) { html += '<ul class="space-y-2 mt-2">'; lines.slice(1).forEach(line => { if (line.trim().startsWith("- De:")) { const content = line.substring(line.indexOf("- De:") + 5).trim(); const parts = content.split(", Sujet: "); html += `<li class="task-item"><strong class="text-blue-300">${parts[0]}:</strong> ${parts.length > 1 ? parts[1] : "Pas de sujet"}</li>`; } }); html += '</ul>'; } else { html += `<p class="mt-2 text-sm text-gray-300">${rawText}</p>`; } return html; }
        function formatTaskList(rawText) { let html = `<h3>Liste des T√¢ches</h3>`; const lines = rawText.split('\n'); const titleMatch = rawText.match(/Voici vos t√¢ches actives de la liste '([^']+)' :/i); if (titleMatch && titleMatch[1]) html = `<h3>T√¢ches Actives - ${titleMatch[1]}</h3>`; else if (rawText.toLowerCase().includes("aucune t√¢che active trouv√©e")) { html += `<p class="mt-2 text-sm text-gray-300">${rawText}</p>`; return html;} html += '<ul class="space-y-1 mt-2">'; let currentTaskTitle = ""; lines.forEach(line => { line = line.trim(); if (line.startsWith("- ")) { if (currentTaskTitle) html += `</div></li>`; currentTaskTitle = line.substring(2).trim(); html += `<li class="task-item"><div><strong>${currentTaskTitle}</strong>`; } else if (line.toLowerCase().startsWith("notes:") && currentTaskTitle) { const notes = line.substring(6).trim(); html += `<p class="task-notes">${notes}</p>`; } }); if (currentTaskTitle) html += `</div></li>`; html += '</ul>'; return html; }
        function formatCalendarEvents(rawText) { let html = `<h3>√âv√©nements du Calendrier</h3>`; const lines = rawText.split('\n'); if (rawText.toLowerCase().includes("aucun √©v√©nement √† venir trouv√©")) { html += `<p class="mt-2 text-sm text-gray-300">${rawText}</p>`; return html; } if (lines.length > 0 && lines[0].toLowerCase().includes("voici vos 10 prochains √©v√©nements")) { html += '<ul class="space-y-1 mt-2">'; lines.slice(1).forEach(line => { line = line.trim(); if (line.startsWith("- ")) { const eventDetails = line.substring(2).trim(); const timeMatch = eventDetails.match(/\(le (.+?)\)$/); const eventName = timeMatch ? eventDetails.substring(0, timeMatch.index).trim() : eventDetails; const eventTime = timeMatch ? timeMatch[1] : ""; html += `<li class="calendar-event-item"><div><strong>${eventName}</strong>${eventTime ? `<p class="calendar-event-time">${eventTime}</p>` : ''}</div></li>`; } }); html += '</ul>'; } else { html += `<p class="mt-2 text-sm text-gray-300">${rawText}</p>`;} return html; }
        function formatContactList(rawText) { let html = `<h3>Liste des Contacts</h3>`; const lines = rawText.split('\n'); if (lines.length > 1 && lines[0].toLowerCase().includes("voici vos contacts")) { html += '<ul class="space-y-2 mt-2">'; lines.slice(1).forEach(line => { if (line.trim().startsWith("- ")) { const contact = line.substring(2).trim(); html += `<li class="task-item">${contact}</li>`; } }); html += '</ul>'; } else { html += `<p class="mt-2 text-sm text-gray-300">${rawText}</p>`; } return html; }
        function getWebcamFrameData() { if (!isCamOn || !webcamVideo.srcObject || webcamVideo.readyState < 3) return null; try { const context = snapshotCanvas.getContext('2d'); snapshotCanvas.width = webcamVideo.videoWidth; snapshotCanvas.height = webcamVideo.videoHeight; context.save(); if (webcamVideo.classList.contains('mirrored')) { context.translate(snapshotCanvas.width, 0); context.scale(-1, 1); } context.drawImage(webcamVideo, 0, 0, snapshotCanvas.width, snapshotCanvas.height); context.restore(); return snapshotCanvas.toDataURL('image/jpeg', 0.8); } catch (error) { console.error("Erreur capture image webcam:", error); return null; } }
        function extractCodeInfo(markdownText) { const infos = []; const regex = /```([a-zA-Z0-9]*)\n([\s\S]*?)\n```/g; let match; while ((match = regex.exec(markdownText)) !== null) infos.push({ language: match[1].toLowerCase() || 'plaintext', code: match[2].trim() }); return infos; }

        // --- Client-side TTS ---
        function speakClientSideMessage(textToSpeak) {
            if (!('speechSynthesis' in window) || isMuted) { evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); return; } 
            speechSynthesis.cancel(); if (recognitionActive && commandRecognizer && !interruptEvaEnabled) { pausedForEvaOutput = true; commandRecognizer.abort(); }
            isSpeakingClientSide = true; evaIsCurrentlySpeaking = true; listeningIndicator.classList.add('speaking'); statusText.textContent = 'EVA parle...' + ((interruptEvaEnabled || userExplicitlyWantsContinuousListen) && (pausedForEvaOutput || interruptEvaEnabled) ? ' (Mode continu en pause)' : '');
            const utterance = new SpeechSynthesisUtterance(textToSpeak); utterance.lang = 'fr-FR';
            utterance.onend = () => { isSpeakingClientSide = false; evaIsCurrentlySpeaking = false; listeningIndicator.classList.remove('speaking'); restartRecognitionAfterEva(); };
            utterance.onerror = (event) => { console.error("Erreur TTS Client:", event.error); isSpeakingClientSide = false; evaIsCurrentlySpeaking = false; listeningIndicator.classList.remove('speaking'); restartRecognitionAfterEva(); };
            setTimeout(() => { speechSynthesis.speak(utterance); }, 50); 
        }

        // --- WebSocket Functions ---
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return; statusText.textContent = "Connexion au serveur..."; 
            ws = new WebSocket(backendWsUrl);
            ws.onopen = () => { wsReady = true; statusText.textContent = "Connect√©. Pr√™t √† discuter."; };
            ws.onmessage = (event) => { 
                try {
                    const serverMessage = JSON.parse(event.data);
                    if (serverMessage.text) addMessageToChat(serverMessage.text, 'assistant');
                    if (serverMessage.panel_data && serverMessage.panel_target_id) {
                        setActiveInfoPanel(serverMessage.panel_target_id, true); const panelData = serverMessage.panel_data;
                        switch (serverMessage.panel_target_id) {
                            case 'mapContent': const directionsInfo = parseDirectionsFromText(panelData); if (directionsInfo) calculateAndDisplayRoute(directionsInfo.origin, directionsInfo.destination); else if(mapElementDiv) mapElementDiv.innerHTML = `<p class="p-4 text-gray-300">${panelData}</p>`; break;
                            case 'searchContent': if(searchResultsContentDiv) searchResultsContentDiv.innerHTML = (panelData.toLowerCase().startsWith("voici vos contacts") || panelData.toLowerCase().startsWith("votre carnet d'adresses est vide")) ? formatContactList(panelData) : formatSearchResults(panelData); break;
                            case 'emailContent': if(emailListContentDiv) emailListContentDiv.innerHTML = formatEmailList(panelData); break;
                            case 'taskContent': if(taskListContentDiv) taskListContentDiv.innerHTML = formatTaskList(panelData); break;
                            case 'calendarContent': if(calendarEventListContentDiv) calendarEventListContentDiv.innerHTML = formatCalendarEvents(panelData); break;
                            case 'weatherForecastContent': displayWeatherForecast(); break; 
                            case 'codeDisplayContent': const codeInfos = extractCodeInfo(panelData); if(evaCodeCanvasContentCode) evaCodeCanvasContentCode.textContent = codeInfos.length > 0 ? codeInfos.map(info => info.code).join('\n\n/* --- Bloc suivant --- */\n\n') : panelData; if (evaCodeCanvasContentWrapper && !evaCodeCanvasContentWrapper.classList.contains('expanded')) { evaCodeCanvasContentWrapper.classList.add('expanded'); if(codeCanvasIcon) codeCanvasIcon.classList.replace('fa-plus', 'fa-minus'); } break;
                            default: console.warn("panel_target_id inconnu:", serverMessage.panel_target_id);
                        }
                    } else if (serverMessage.type === 'final_text' && serverMessage.text) {
                        const codeInfos = extractCodeInfo(serverMessage.text);
                        if (codeInfos.length > 0 && activeInfoPanelId !== 'codeDisplayContent') { setActiveInfoPanel('codeDisplayContent', true); if(evaCodeCanvasContentCode) evaCodeCanvasContentCode.textContent = codeInfos.map(info => info.code).join('\n\n/* --- Bloc suivant --- */\n\n'); if (evaCodeCanvasContentWrapper && !evaCodeCanvasContentWrapper.classList.contains('expanded')) { evaCodeCanvasContentWrapper.classList.add('expanded'); if(codeCanvasIcon) codeCanvasIcon.classList.replace('fa-plus', 'fa-minus'); } const chatMsgForCode = serverMessage.text.replace(/```(?:[a-zA-Z0-9]*)?\n[\s\S]*?\n```/g, "").trim(); if (chatbox.lastChild && chatbox.lastChild.textContent === serverMessage.text) { chatbox.lastChild.textContent = chatMsgForCode || "Code g√©n√©r√©. (Affich√© dans l'onglet Code)"; } }
                    }
                    if (serverMessage.type === 'audio_data') { if (skipNextAudioDueToCode) { skipNextAudioDueToCode = false; evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); } else if (!isMuted && serverMessage.audio) playAudio(serverMessage.audio); else { evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); } } 
                    else if (serverMessage.type === 'no_audio_data' || serverMessage.type === 'error') { if (skipNextAudioDueToCode) skipNextAudioDueToCode = false; evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); }
                } catch (error) { console.error("Erreur traitement message serveur:", error); addMessageToChat("Erreur communication.", "assistant"); skipNextAudioDueToCode = false; evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); }
            };
            ws.onerror = (error) => { console.error("Erreur WebSocket:", error); statusText.textContent = "Erreur connexion WebSocket."; addMessageToChat("Erreur connexion chat.", "assistant"); wsReady = false; skipNextAudioDueToCode = false; evaIsCurrentlySpeaking = false; };
            ws.onclose = () => { wsReady = false; statusText.textContent = "D√©connect√©. Reconnexion..."; skipNextAudioDueToCode = false; evaIsCurrentlySpeaking = false; setTimeout(connectWebSocket, wsRetryInterval); };
        }
        function sendMessageViaWebSocket(speechTranscript = null) {
            let messageTextToSend = speechTranscript ? speechTranscript.trim() : messageInput.value.trim();
            const requestData = { text: messageTextToSend, imageData: (isCamOn && !attachedFile) ? getWebcamFrameData() : null, fileData: attachedFile ? attachedFile.data : null, fileName: attachedFile ? attachedFile.name : null, fileType: attachedFile ? attachedFile.type : null };
            if (!messageTextToSend && !requestData.imageData && !requestData.fileData) { statusText.textContent = speechTranscript ? 'Rien compris.' : 'Rien √† envoyer.'; messageInput.value = ''; if (attachedFile) clearAttachedFile(); restartRecognitionAfterEva(); return; }
            if (!wsReady || !ws || ws.readyState !== WebSocket.OPEN) { addMessageToChat("Non connect√©. Reconnexion...", "assistant"); connectWebSocket(); return; }
            addMessageToChat(messageTextToSend || `Fichier : ${requestData.fileName}`, 'user');
            if (!interruptEvaEnabled) { pausedForEvaOutput = true; if (recognitionActive && commandRecognizer) commandRecognizer.abort(); statusText.textContent = 'Traitement...'; }
            try { ws.send(JSON.stringify(requestData)); messageInput.value = ''; clearAttachedFile(); } 
            catch (error) { addMessageToChat(`Erreur envoi: ${error.message}`, 'assistant'); restartRecognitionAfterEva(); }
        }
        function playAudio(audioSource) {
            if (isMuted) { evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); return; } if (isSpeakingClientSide) { evaIsCurrentlySpeaking = false; return; } 
            if (recognitionActive && commandRecognizer && !interruptEvaEnabled) { pausedForEvaOutput = true; commandRecognizer.abort(); }
            statusText.textContent = 'EVA parle...' + ((interruptEvaEnabled || userExplicitlyWantsContinuousListen) && (pausedForEvaOutput || interruptEvaEnabled) ? ' (Mode continu en pause)' : '');
            evaIsCurrentlySpeaking = true; audioPlayer.src = audioSource; audioPlayer.play().catch(e => { console.error("Erreur lecture audio:", e); listeningIndicator.classList.remove('speaking'); evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); });
            listeningIndicator.classList.add('speaking'); 
            audioPlayer.onended = () => { listeningIndicator.classList.remove('speaking'); evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); };
        }
        function restartRecognitionAfterEva() {
            console.log("Red√©marrage reco. apr√®s EVA. Paused:", pausedForEvaOutput, "Interrupt:", interruptEvaEnabled, "Continuous:", userExplicitlyWantsContinuousListen, "EvaActivated:", isEvaActivatedListening); pausedForEvaOutput = false; 
            if (interruptEvaEnabled) { if (!recognitionActive) startCommandRecognition(true); } 
            else if (userExplicitlyWantsContinuousListen) { if (!recognitionActive) startCommandRecognition(true); } 
            else if (isEvaActivatedListening) { isEvaActivatedListening = false; if (!wakeWordRecognitionActive && !recognitionActive) startWakeWordRecognition(); } 
            else { if (!wakeWordRecognitionActive && !recognitionActive) startWakeWordRecognition(); }
        }

        // --- Webcam & Mute ---
        async function startStream() {
            webcamError.classList.add('hidden'); if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); }
            const deviceId = availableCameras[currentCameraIndex]?.deviceId; const constraints = { video: { deviceId: deviceId ? { exact: deviceId } : undefined }, audio: false };
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints); webcamVideo.srcObject = mediaStream;
                webcamVideo.onloadedmetadata = () => {
                    webcamVideo.classList.remove('hidden'); listeningIndicator.classList.add('hidden');
                    webcamVideo.classList.toggle('mirrored', currentCameraIndex === 0);
                    isCamOn = true; camIcon.classList.replace('fa-video-slash', 'fa-video');
                    camButton.classList.replace('bg-gray-600', 'bg-red-600'); camButton.classList.replace('hover:bg-gray-700', 'hover:bg-red-700');
                    if (availableCameras.length > 1) { switchCamButton.classList.remove('hidden'); }
                };
            } catch (err) { handleCameraError(err); }
        }
        function handleCameraError(err) {
            webcamError.textContent = `Erreur: ${err.name || err.message}`; webcamError.classList.remove('hidden');
            isCamOn = false; if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); }
            webcamVideo.srcObject = null; webcamVideo.classList.add('hidden'); listeningIndicator.classList.remove('hidden');
            camIcon.classList.replace('fa-video', 'fa-video-slash');
            camButton.classList.replace('bg-red-600', 'bg-gray-600'); camButton.classList.replace('hover:bg-red-700', 'hover:bg-gray-700');
            switchCamButton.classList.add('hidden');
        }
        async function toggleWebcam(playSound = true) {
            if (isCamOn) {
                if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); }
                isCamOn = false; webcamVideo.srcObject = null; webcamVideo.classList.add('hidden'); listeningIndicator.classList.remove('hidden');
                camIcon.classList.replace('fa-video', 'fa-video-slash');
                camButton.classList.replace('bg-red-600', 'bg-gray-600'); camButton.classList.replace('hover:bg-red-700', 'hover:bg-gray-700');
                switchCamButton.classList.add('hidden'); webcamError.classList.add('hidden'); if(playSound) cameraToggleSound();
            } else {
                if (availableCameras.length === 0) {
                    try { const devices = await navigator.mediaDevices.enumerateDevices(); availableCameras = devices.filter(device => device.kind === 'videoinput'); if (availableCameras.length === 0) { handleCameraError({name: "NoCamera", message: "Aucune cam√©ra trouv√©e."}); return; }
                    } catch (err) { handleCameraError(err); return; }
                }
                await startStream(); if(playSound) cameraToggleSound();
            }
        }
        async function switchCamera() { if (!isCamOn || availableCameras.length <= 1) return; currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length; await startStream(); }
        function toggleMute() {
            isMuted = !isMuted; 
            muteIcon.classList.toggle('fa-volume-up', !isMuted); muteIcon.classList.toggle('fa-volume-mute', isMuted);
            muteButton.classList.toggle('bg-red-600', isMuted); muteButton.classList.toggle('hover:bg-red-700', isMuted); 
            muteButton.classList.toggle('bg-gray-600', !isMuted); muteButton.classList.toggle('hover:bg-gray-700', !isMuted);
            if (isMuted && audioPlayer && !audioPlayer.paused) { audioPlayer.pause(); listeningIndicator.classList.remove('speaking'); evaIsCurrentlySpeaking = false; statusText.textContent = 'Muet. ' + (userExplicitlyWantsContinuousListen ? 'Mode continu en attente.' : (wakeWordRecognitionActive ? "Dites 'Eva'..." : 'Appuyez sur Espace/Micro.')); }
            if (isMuted && isSpeakingClientSide) { speechSynthesis.cancel(); isSpeakingClientSide = false; listeningIndicator.classList.remove('speaking'); evaIsCurrentlySpeaking = false; restartRecognitionAfterEva(); }
        }

        // --- Prompt Scheduler Functions ---
        function schedulePrompt() { const text = scheduledPromptTextInput.value.trim(); const timeString = scheduledPromptTimeInput.value; const frequency = promptFrequencyInput.value; const indefinite = promptIndefiniteCheckbox.checked; let repetitions = parseInt(promptRepetitionsInput.value, 10); if (!text || !timeString) { addMessageToChat("Veuillez entrer un texte et une heure.", "assistant"); setActiveInfoPanel('schedulerContent', true); return; } if (frequency !== 'once' && !indefinite && (isNaN(repetitions) || repetitions < 1)) { addMessageToChat("Veuillez entrer un nombre de r√©p√©titions valide.", "assistant"); setActiveInfoPanel('schedulerContent', true); return; } if (frequency !== 'once' && indefinite) repetitions = 0; const initialScheduledTime = new Date(timeString).getTime(); if (initialScheduledTime <= Date.now()) { addMessageToChat("L'heure est d√©j√† pass√©e.", "assistant"); setActiveInfoPanel('schedulerContent', true); return; } const promptId = `prompt-${Date.now()}`; const newPrompt = { id: promptId, text: text, time: initialScheduledTime, originalScheduledTime: initialScheduledTime, frequency: frequency, repetitions: repetitions, indefinite: indefinite, executedCount: 0, isActive: true, timeoutId: null }; scheduledPrompts.push(newPrompt); scheduleNextOccurrence(promptId); renderScheduledPrompts(); scheduledPromptTextInput.value = ""; promptFrequencyInput.value = 'once'; recurrenceOptionsDiv.classList.add('hidden'); promptRepetitionsInput.value = "1"; promptIndefiniteCheckbox.checked = false; promptRepetitionsInput.disabled = false; let scheduleMessage = `Prompt "${text}" planifi√© pour ${new Date(initialScheduledTime).toLocaleString('fr-FR')}`; if (frequency !== 'once') scheduleMessage += `, fr√©quence: ${translateFrequency(frequency)}${!indefinite ? `, ${repetitions} fois` : ', ind√©finiment'}`; addMessageToChat(scheduleMessage + ".", "assistant"); setActiveInfoPanel('schedulerContent', true); }
        function calculateNextTime(baseTime, frequency) { const nextDate = new Date(baseTime); switch (frequency) { case 'daily': nextDate.setDate(nextDate.getDate() + 1); break; case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break; case 'monthly': nextDate.setMonth(nextDate.getMonth() + 1); break; default: return null; } return nextDate; }
        function scheduleNextOccurrence(promptId) { const promptIndex = scheduledPrompts.findIndex(p => p.id === promptId); if (promptIndex === -1) return; const prompt = scheduledPrompts[promptIndex]; if (prompt.timeoutId) clearTimeout(prompt.timeoutId); if (!prompt.isActive) { renderScheduledPrompts(); return; } let targetTime = prompt.time; const currentTime = Date.now(); if (targetTime < currentTime && prompt.frequency !== 'once') { let newCalculatedTime = new Date(prompt.originalScheduledTime); while(newCalculatedTime.getTime() <= currentTime || newCalculatedTime.getTime() < prompt.time) { const next = calculateNextTime(newCalculatedTime.getTime(), prompt.frequency); if(!next) break; newCalculatedTime = next; } targetTime = newCalculatedTime.getTime(); prompt.time = targetTime; } const delay = targetTime - currentTime; if (delay < 0 && prompt.frequency === 'once') { addMessageToChat(`Prompt unique "${prompt.text}" est pass√©.`, "assistant"); scheduledPrompts.splice(promptIndex, 1); renderScheduledPrompts(); return; } prompt.timeoutId = setTimeout(() => executeAndReschedule(promptId), Math.max(0, delay)); renderScheduledPrompts(); }
        function executeAndReschedule(promptId) { const promptIndex = scheduledPrompts.findIndex(p => p.id === promptId); if (promptIndex === -1) return; const prompt = scheduledPrompts[promptIndex]; if (!prompt.isActive) return; addMessageToChat(`Ex√©cution du prompt : "${prompt.text}"`, "assistant"); sendMessageViaWebSocket(prompt.text); prompt.executedCount++; if (prompt.frequency === 'once' || (!prompt.indefinite && prompt.executedCount >= prompt.repetitions)) { addMessageToChat(`Prompt "${prompt.text}" termin√©.`, "assistant"); if(prompt.timeoutId) clearTimeout(prompt.timeoutId); scheduledPrompts.splice(promptIndex, 1); } else { const nextTime = calculateNextTime(prompt.time, prompt.frequency); if (nextTime) { prompt.time = nextTime.getTime(); scheduleNextOccurrence(promptId); } else { if(prompt.timeoutId) clearTimeout(prompt.timeoutId); scheduledPrompts.splice(promptIndex, 1); } } renderScheduledPrompts(); }
        function cancelScheduledPrompt(promptId) { const promptIndex = scheduledPrompts.findIndex(p => p.id === promptId); if (promptIndex > -1) { const canceledPrompt = scheduledPrompts[promptIndex]; if (canceledPrompt.timeoutId) clearTimeout(canceledPrompt.timeoutId); scheduledPrompts.splice(promptIndex, 1); renderScheduledPrompts(); addMessageToChat(`Prompt annul√© : "${canceledPrompt.text}"`, "assistant"); setActiveInfoPanel('schedulerContent', true); } }
        function togglePromptActiveState(promptId) { const promptIndex = scheduledPrompts.findIndex(p => p.id === promptId); if (promptIndex === -1) return; const prompt = scheduledPrompts[promptIndex]; prompt.isActive = !prompt.isActive; if (prompt.isActive) { addMessageToChat(`Prompt "${prompt.text}" repris.`, "assistant"); if (prompt.time < Date.now() && prompt.frequency !== 'once') { let newTime = new Date(prompt.originalScheduledTime); while (newTime.getTime() <= Date.now()) { const calculated = calculateNextTime(newTime.getTime(), prompt.frequency); if (!calculated) break; newTime = calculated; } prompt.time = newTime.getTime(); } scheduleNextOccurrence(promptId); } else { addMessageToChat(`Prompt "${prompt.text}" mis en pause.`, "assistant"); if (prompt.timeoutId) { clearTimeout(prompt.timeoutId); prompt.timeoutId = null; } } renderScheduledPrompts(); }
        function translateFrequency(freq) { const map = {'once': 'Une fois', 'daily': 'Quotidien', 'weekly': 'Hebdomadaire', 'monthly': 'Mensuel'}; return map[freq] || freq; }
        function renderScheduledPrompts() { scheduledPromptsListUI.innerHTML = scheduledPrompts.length === 0 ? "<li class='text-gray-400'>Aucun prompt planifi√©.</li>" : ""; if(scheduledPrompts.length === 0) return; [...scheduledPrompts].sort((a, b) => a.time - b.time).forEach(prompt => { const listItem = document.createElement('li'); const date = new Date(prompt.time); let detailsText = `"${prompt.text}" - ${prompt.isActive ? 'Prochaine ex√©cution' : 'PAUSE (Pr√©vu'}: ${date.toLocaleString('fr-FR')})`; if (prompt.frequency !== 'once') detailsText += ` (${translateFrequency(prompt.frequency)}${!prompt.indefinite ? `, ${prompt.executedCount}/${prompt.repetitions}ex` : `, ${prompt.executedCount}ex - Ind√©fini`})`; listItem.innerHTML = `<div class="prompt-details">${detailsText}</div><div class="prompt-actions">${prompt.frequency !== 'once' ? `<button data-id="${prompt.id}" class="${prompt.isActive ? 'pause' : 'resume'}-prompt-button">${prompt.isActive ? 'Pause' : 'Reprendre'}</button>` : ''}<button data-id="${prompt.id}" class="cancel-prompt-button">Annuler</button></div>`; scheduledPromptsListUI.appendChild(listItem); }); document.querySelectorAll('.cancel-prompt-button, .pause-prompt-button, .resume-prompt-button').forEach(button => { button.addEventListener('click', (event) => { const id = event.target.dataset.id; if(event.target.classList.contains('cancel-prompt-button')) cancelScheduledPrompt(id); else togglePromptActiveState(id); }); }); }
        
        // --- File Handling ---
        function handleFileSelect(event) { const file = event.target.files[0]; if (!file) { clearAttachedFile(); return; } const fileType = file.type; const fileName = file.name; const reader = new FileReader(); reader.onload = (e) => { attachedFile = { name: fileName, type: fileType.startsWith('image/') ? 'image' : 'audio', data: e.target.result }; displayFilePreview(fileName, fileType.startsWith('image/') ? e.target.result : null); if (fileType.startsWith('audio/')) { sendMessageViaWebSocket(`transcrire le fichier ${fileName}`); } }; if (fileType.startsWith('image/') || fileType.startsWith('audio/')) { reader.readAsDataURL(file); } else if (fileType.startsWith('text/') || ['.py','.js','.html','.css','.json','.md'].some(ext => fileName.endsWith(ext))) { reader.onload = (e) => { attachedFile = { name: fileName, type: 'text', data: e.target.result }; displayFilePreview(fileName, null); }; reader.readAsText(file); } else { addMessageToChat(`Type de fichier non support√©: ${fileName}`, "assistant"); clearAttachedFile(); } fileInput.value = ''; }
        function displayFilePreview(fileName, imageSrc = null) { filePreviewContainer.innerHTML = `${imageSrc ? `<img src="${imageSrc}" alt="Aper√ßu de ${fileName}"><br>` : ''}<span class="mr-2">${fileName}</span> <button id="removeFileButton" class="text-red-500 hover:text-red-700 text-xs">&times;</button>`; document.getElementById('removeFileButton').addEventListener('click', clearAttachedFile); }
        function clearAttachedFile() { attachedFile = null; filePreviewContainer.innerHTML = ''; fileInput.value = ''; }

        // --- Calculator Logic ---
        function updateCalculatorDisplay() { if(calculatorDisplay) { let displayValue = calculatorCurrentInput || calculatorPreviousInput || "0"; if (displayValue.length > MAX_INPUT_LENGTH) { displayValue = displayValue.substring(0, MAX_INPUT_LENGTH) + "..."; } calculatorDisplay.textContent = displayValue; } }
        function handleCalculatorInput(value) { if (calculatorResetDisplay && !['(', ')'].includes(value)) { calculatorCurrentInput = ""; calculatorResetDisplay = false; } if (calculatorCurrentInput.length >= MAX_INPUT_LENGTH && !['C', '=', 'sin', 'cos', 'tan', 'sqrt', 'log', 'ln', '!'].includes(value)) { return; } if (value >= '0' && value <= '9') { calculatorCurrentInput += value; } else if (value === '.') { if (!calculatorCurrentInput.includes('.')) { calculatorCurrentInput += '.'; } } else if (value === 'C') { calculatorCurrentInput = ""; calculatorPreviousInput = ""; calculatorOperator = null; } else if (value === '=') { if (calculatorOperator && calculatorPreviousInput !== "" && calculatorCurrentInput !== "") { try { let expressionToEvaluate = calculatorPreviousInput + calculatorOperator + calculatorCurrentInput; if (calculatorOperator === '^') { expressionToEvaluate = `Math.pow(${calculatorPreviousInput}, ${calculatorCurrentInput})`; } const sanitizedExpression = expressionToEvaluate.replace(/[^-()\d/*+.]/g, ''); let result = new Function('return ' + sanitizedExpression)(); if (!isFinite(result)) { calculatorCurrentInput = "D√©passement"; } else { calculatorCurrentInput = result.toString(); } calculatorOperator = null; calculatorPreviousInput = ""; calculatorResetDisplay = true; } catch (e) { console.error("Erreur calculatrice:", e); calculatorCurrentInput = "Erreur"; calculatorResetDisplay = true; } } } else if (['+', '-', '*', '/', '^'].includes(value)) { if (calculatorCurrentInput !== "") { if (calculatorPreviousInput === "") { calculatorPreviousInput = calculatorCurrentInput; calculatorCurrentInput = ""; calculatorOperator = value; } else if (calculatorOperator) { handleCalculatorInput('='); if (calculatorCurrentInput !== "Erreur" && calculatorCurrentInput !== "D√©passement") { calculatorPreviousInput = calculatorCurrentInput; calculatorCurrentInput = ""; calculatorOperator = value; calculatorResetDisplay = false; } else { calculatorPreviousInput = ""; calculatorOperator = null; } } } else if (calculatorPreviousInput !== "" && value === "-" && calculatorOperator && calculatorCurrentInput === "") { calculatorCurrentInput = "-"; } else if (calculatorPreviousInput !== "" && !calculatorOperator) { calculatorOperator = value; calculatorCurrentInput = ""; calculatorResetDisplay = false; } } else { if (value === '(') { calculatorCurrentInput += '('; calculatorResetDisplay = false; } else if (value === ')') { calculatorCurrentInput += ')'; calculatorResetDisplay = false; } else if (calculatorCurrentInput !== "" || ['pi', 'e'].includes(value)) { const num = parseFloat(calculatorCurrentInput); if (isNaN(num) && !['pi', 'e'].includes(value) && !calculatorCurrentInput.endsWith(')')) {} else { try { let result; switch(value) { case 'sin': result = Math.sin(num * Math.PI / 180); break; case 'cos': result = Math.cos(num * Math.PI / 180); break; case 'tan': result = Math.tan(num * Math.PI / 180); break; case 'sqrt': result = Math.sqrt(num); break; case 'log': result = Math.log10(num); break; case 'ln': result = Math.log(num); break; case '!': if (num < 0 || !Number.isInteger(num) || num > 170) { result = Infinity; break; } let fact = 1; for (let i = 2; i <= num; i++) fact *= i; result = fact; break; case 'pi': result = Math.PI; break; case 'e': result = Math.E; break; default: result = num; } if (!isFinite(result)) { calculatorCurrentInput = "D√©passement"; } else { calculatorCurrentInput = result.toString(); } calculatorResetDisplay = true; } catch (e) { console.error("Erreur fonction calculatrice:", e); calculatorCurrentInput = "Erreur"; calculatorResetDisplay = true; } } } else if (['pi', 'e'].includes(value)) { calculatorCurrentInput = (value === 'pi' ? Math.PI : Math.E).toString(); calculatorResetDisplay = true; } } updateCalculatorDisplay(); }

        // --- Event Listeners ---
        sendButton.addEventListener('click', () => sendMessageViaWebSocket());
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessageViaWebSocket(); });
        micButton.addEventListener('click', () => { if (!SpeechRecognitionAPI) return; initAudioContext(); if (recognitionActive) { userExplicitlyWantsContinuousListen = false; isEvaActivatedListening = false; stopCommandRecognition(); startWakeWordRecognition(); } else { userExplicitlyWantsContinuousListen = false; isEvaActivatedListening = false; stopWakeWordRecognition(); startCommandRecognition(false); } });
        interruptModeButton.addEventListener('click', () => { initAudioContext(); interruptEvaEnabled = !interruptEvaEnabled; interruptModeButton.classList.toggle('bg-orange-500', interruptEvaEnabled); interruptModeButton.classList.toggle('hover:bg-orange-600', interruptEvaEnabled); interruptModeButton.classList.toggle('bg-yellow-500', !interruptEvaEnabled); interruptModeButton.classList.toggle('hover:bg-yellow-600', !interruptEvaEnabled); interruptModeButton.title = `Interruption EVA (${interruptEvaEnabled ? 'Activ√©' : 'D√©sactiv√©'}) (i)`; if (interruptEvaEnabled) { userExplicitlyWantsContinuousListen = true; isEvaActivatedListening = false; stopWakeWordRecognition(); if (!recognitionActive) startCommandRecognition(true); statusText.textContent = "Mode interruption: Activ√©. √âcoute..."; } else { userExplicitlyWantsContinuousListen = false; stopCommandRecognition(); startWakeWordRecognition(); statusText.textContent = "Mode interruption: D√©sactiv√©."; } });
        muteButton.addEventListener('click', toggleMute); 
        camButton.addEventListener('click', () => { initAudioContext(); toggleWebcam(); });
        switchCamButton.addEventListener('click', () => { initAudioContext(); switchCamera(); });
        schedulePromptButton.addEventListener('click', schedulePrompt);
        attachFileButton.addEventListener('click', () => fileInput.click()); 
        fileInput.addEventListener('change', handleFileSelect);
        promptFrequencyInput.addEventListener('change', () => { recurrenceOptionsDiv.classList.toggle('hidden', promptFrequencyInput.value === 'once'); });
        promptIndefiniteCheckbox.addEventListener('change', () => { promptRepetitionsInput.disabled = promptIndefiniteCheckbox.checked; if (promptIndefiniteCheckbox.checked) promptRepetitionsInput.value = ""; else promptRepetitionsInput.value = "1"; });
        if (authorizeGoogleButton) authorizeGoogleButton.addEventListener('click', () => { window.open(`${backendHttpUrl}/authorize_google`, '_blank'); if (authStatus) authStatus.textContent = "Autorisation Google lanc√©e..."; });
        document.addEventListener('keydown', (e) => { const activeEl = document.activeElement; if ([messageInput, scheduledPromptTextInput, scheduledPromptTimeInput, promptRepetitionsInput].includes(activeEl)) return; initAudioContext(); if (e.code === 'Space') { e.preventDefault(); userExplicitlyWantsContinuousListen = !userExplicitlyWantsContinuousListen; isEvaActivatedListening = false; if (userExplicitlyWantsContinuousListen) { stopWakeWordRecognition(); if (!recognitionActive) startCommandRecognition(true); } else { stopCommandRecognition(); startWakeWordRecognition(); } } else if (e.key.toLowerCase() === 'c' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); toggleWebcam(); } else if (e.key.toLowerCase() === 'm' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); toggleMute(); } else if (e.key.toLowerCase() === 'i' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); interruptModeButton.click(); } });
        toggleInfoPanelButton.addEventListener('click', () => { infoPanelColumn.classList.toggle('collapsed'); const isCollapsed = infoPanelColumn.classList.contains('collapsed'); const leftIcon = toggleInfoPanelButton.querySelector('.fa-chevron-left'); const rightIcon = toggleInfoPanelButton.querySelector('.fa-chevron-right'); if(leftIcon) leftIcon.style.display = isCollapsed ? 'none' : 'inline-block'; if(rightIcon) rightIcon.style.display = isCollapsed ? 'inline-block' : 'none'; if (!isCollapsed && activeInfoPanelId === 'mapContent' && typeof google !== 'undefined' && google.maps && gMap) { setTimeout(() => { google.maps.event.trigger(gMap, 'resize'); gMap.setCenter(currentMapCenter); gMap.setZoom(currentMapZoom); }, 350); } });
        infoPanelTabsContainer.addEventListener('click', (event) => { if (event.target.classList.contains('info-tab-button')) { setActiveInfoPanel(event.target.dataset.target, false); } });
        if (toggleCodeCanvasButton) { toggleCodeCanvasButton.addEventListener('click', () => { if (evaCodeCanvasContentWrapper) evaCodeCanvasContentWrapper.classList.toggle('expanded'); if (codeCanvasIcon) { codeCanvasIcon.classList.toggle('fa-plus'); codeCanvasIcon.classList.toggle('fa-minus'); } }); }
        if (calculatorButtonsContainer) { calculatorButtonsContainer.addEventListener('click', (event) => { if (event.target.classList.contains('calc-button')) { handleCalculatorInput(event.target.dataset.value); } }); }

        // --- Initialisation on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', initAudioContext, { once: true });
            updateDateTimeDashboard(); setInterval(updateDateTimeDashboard, 1000); 
            getUserLocationAndFetchWeather(); setInterval(getUserLocationAndFetchWeather, 15 * 60 * 1000); 
            connectWebSocket(); 
            addMessageToChat("Si vous souhaitez utiliser les fonctionnalit√©s Google (Agenda, Gmail, etc.), cliquez sur le bouton Google.", "assistant");
            if (infoPanelColumn) infoPanelColumn.classList.add('collapsed'); 
            const leftIcon = toggleInfoPanelButton.querySelector('.fa-chevron-left'); const rightIcon = toggleInfoPanelButton.querySelector('.fa-chevron-right');
            if(leftIcon) leftIcon.style.display = 'none'; if(rightIcon) rightIcon.style.display = 'inline-block';
            setActiveInfoPanel('mapContent', false); 
            if (evaCodeCanvasContentWrapper && !evaCodeCanvasContentWrapper.classList.contains('expanded')) { if(codeCanvasIcon) { codeCanvasIcon.classList.remove('fa-minus'); codeCanvasIcon.classList.add('fa-plus');} } 
            else { if(codeCanvasIcon) { codeCanvasIcon.classList.remove('fa-plus'); codeCanvasIcon.classList.add('fa-minus');} }
            renderScheduledPrompts(); updateCalculatorDisplay(); 
            if (interruptModeButton) interruptModeButton.title = "Activer l'interruption d'EVA (D√©sactiv√©) (ou touche 'i')";
            if(promptFrequencyInput && recurrenceOptionsDiv) recurrenceOptionsDiv.classList.toggle('hidden', promptFrequencyInput.value === 'once');
            if(promptIndefiniteCheckbox && promptRepetitionsInput) promptRepetitionsInput.disabled = promptIndefiniteCheckbox.checked;
            window.addEventListener('resize', () => { if (typeof google !== 'undefined' && google.maps && gMap && activeInfoPanelId === 'mapContent' && infoPanelColumn && !infoPanelColumn.classList.contains('collapsed')) { google.maps.event.trigger(gMap, 'resize'); gMap.setCenter(currentMapCenter); gMap.setZoom(currentMapZoom); } });
            if (SpeechRecognitionAPI) { startWakeWordRecognition(); } 
            else { statusText.textContent = "Reconnaissance vocale non support√©e par ce navigateur."; if (micButton) micButton.disabled = true; }
        });
    </script>
</body>
</html>
